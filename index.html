<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <meta name="theme-color" content="#222222">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log("Service Worker registered!", reg))
        .catch(err => console.error("Service Worker failed", err));
    }
  </script>
  <meta charset="UTF-8">
  <title>Tab Scribe</title>
  <style>
    body {
      font-family: 'Oswald', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      transition: background 0.3s, color 0.3s;
    }
    .dark-mode {
      background: #222;
      color: #eee;
    }
    .tab-grid {
      display: grid;
      gap: 5px;
      margin-bottom: 20px;
    }
    .cell {
      width: 40px;
      height: 40px;
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
      background: white;
      font-size: 16px;
    }
    .dark-mode .cell {
      background: #444;
      color: #fff;
      border-color: #888;
    }
    .string-label {
      font-weight: bold;
      text-align: center;
      border: none;
    }
    .output {
      white-space: pre;
      background: #fff;
      border: 1px solid #aaa;
      padding: 10px;
      font-family: monospace;
    }
    .dark-mode .output {
      background: #333;
      color: #eee;
      border-color: #666;
    }
    button, input, select {
      padding: 10px;
      font-size: 16px;
      margin: 5px 5px 5px 0;
    }
    .section-input {
      margin-top: 10px;
    }

    /* Icon Buttons */
    #helpBtn, #aboutBtn {
      position: absolute;
      top: 20px;
      font-size: 1.2em;
      background: none;
      border: none;
      cursor: pointer;
    }
    #helpBtn {
      right: 20px;
    }
    #aboutBtn {
      right: 60px;
    }

    /* Modal Styling */
    #helpModal, #aboutModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 600px;
      background: white;
      padding: 20px;
      border: 1px solid #aaa;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .dark-mode #helpModal, .dark-mode #aboutModal {
      background: #333;
      color: #eee;
      border-color: #666;
    }
  </style>
</head>
<body>

  <button id="aboutBtn">‚ÑπÔ∏è</button>
  <button id="helpBtn">‚ùì</button>

  <header style="text-align: center; margin-top: 20px;">
    <h1 style="font-family: 'Anton', sans-serif; font-size: 2.5em; font-weight: bold; letter-spacing: -1px;">
      Tab Scribe
    </h1>
    <p style="font-size: 0.9em; color: #555;">V0.3.1</p>
  </header>

  <div>
    <button onclick="addColumn()">‚ûï Column (Beat)</button>
    <button onclick="removeColumn()">‚ûñ Column (Beat)</button>
    <button onclick="toggleDarkMode()">üåò Dark Mode</button>
  </div>

  <div id="tabGrid" class="tab-grid"></div>

  <div>
    <input type="text" id="sectionLabel" placeholder="Section Marker (e.g., Chorus)" class="section-input" />
    <button onclick="exportTab()">Post Measure</button>
    <button onclick="clearGrid()">Clear Grid</button>
  </div>

  <div>
    <input type="text" id="tabName" placeholder="Tab Name" />
    <button onclick="saveNamedTab()">üíæ Save Tab</button>
    <button onclick="exportToFile()">‚¨áÔ∏è Export to .txt</button>
    <select id="savedTabs" onchange="loadNamedTab()">
      <option value="">-- Load Saved Tab --</option>
    </select>
  </div>

  <h3>Full Tab:</h3>
  <div id="tabOutput" class="output"></div>

  <!-- Help Modal -->
  <div id="helpModal">
    <h2>How to Use Tab Scribe</h2>
    <ol>
      <li>Click "‚ûï Column" to add a beat (set of tab columns).</li>
      <li>Type the fret numbers in the cells for each string.</li>
      <li>Click "‚ûñ Column" to remove a column (beat).</li>
      <li>Use "Section Marker" to label your section (e.g., Chorus).</li>
      <li>Click "Post Measure" to add it to the full tab below.</li>
      <li>Use "Clear Grid" to reset your current measure.</li>
      <li>Enter a tab name and click "üíæ Save Tab" to store it.</li>
      <li>Use the dropdown to reload saved tabs.</li>
      <li>Click "‚¨áÔ∏è Export to .txt" to download your full tab.</li>
      <li>Toggle Dark Mode for late-night sessions. üé∏</li>
    </ol>
    <button onclick="document.getElementById('helpModal').style.display='none'">Close</button>
  </div>

  <!-- About Modal -->
  <div id="aboutModal">
    <h2>About Tab Scribe</h2>
    <p><strong>Tab Scribe</strong> is a lightweight, browser-based guitar tab writing tool designed for intuitive composition, editing, and export. It lets you build tablature beat by beat, mark sections, and write freely ‚Äî without being locked into a full DAW or notation software. Perfect for sketching riffs, saving quick ideas, or sharing with bandmates.</p>
    <p>More features ‚Äî like note labeling, lyric/chord overlays, and PDF export ‚Äî are coming soon. Built for simplicity, speed, and players who just want to write.</p>
    <button onclick="document.getElementById('aboutModal').style.display='none'">Close</button>
  </div>

  <script>
    const strings = ['e', 'B', 'G', 'D', 'A', 'E'];
    let columns = 8;

    const grid = document.getElementById('tabGrid');
    const outputBox = document.getElementById('tabOutput');
    const savedTabsDropdown = document.getElementById('savedTabs');

    let cells = [];
    let fullTab = '';

    function createGrid() {
      grid.innerHTML = '';
      grid.style.gridTemplateColumns = `repeat(${columns + 1}, auto)`;
      cells = [];

      for (let row = 0; row < strings.length; row++) {
        const rowCells = [];
        for (let col = 0; col <= columns; col++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');

          if (col === 0) {
            cell.innerText = strings[row];
            cell.classList.add('string-label');
          } else {
            cell.contentEditable = true;
            cell.addEventListener('input', () => {
              if (cell.innerText.length > 2) {
                cell.innerText = cell.innerText.slice(0, 2);
              }
            });
            rowCells.push(cell);
          }

          grid.appendChild(cell);
        }
        cells.push(rowCells);
      }
    }

    function exportTab() {
      const section = document.getElementById('sectionLabel').value.trim();
      let measure = section ? `[${section.toUpperCase()}]\n` : '';

      for (let row = 0; row < strings.length; row++) {
        let line = strings[row] + '|';
        for (let col = 0; col < columns; col++) {
          const val = cells[row][col].innerText.trim();
          if (val === '') {
            line += '--';
          } else if (val.length === 1) {
            line += '-' + val;
          } else {
            line += val;
          }
        }
        line += '|';
        measure += line + '\n';
      }

      fullTab += measure + '\n';
      outputBox.innerText = fullTab;
      document.getElementById('sectionLabel').value = '';
    }

    function clearGrid() {
      for (let row of cells) {
        for (let cell of row) {
          cell.innerText = '';
        }
      }
    }

    function addColumn() {
      columns++;
      createGrid();
    }

    function removeColumn() {
      if (columns > 1) {
        columns--;
        createGrid();
      }
    }

    function saveNamedTab() {
      const name = document.getElementById('tabName').value.trim();
      if (!name) return alert("Name your tab first!");
      localStorage.setItem(`tabby_${name}`, fullTab);
      loadSavedTabList();
      alert(`Tab "${name}" saved.`);
    }

    function loadNamedTab() {
      const name = savedTabsDropdown.value;
      if (!name) return;
      const saved = localStorage.getItem(`tabby_${name}`);
      if (saved) {
        fullTab = saved;
        outputBox.innerText = fullTab;
      }
    }

    function loadSavedTabList() {
      savedTabsDropdown.innerHTML = '<option value="">-- Load Tab --</option>';
      for (let key in localStorage) {
        if (key.startsWith('tabby_')) {
          const name = key.replace('tabby_', '');
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          savedTabsDropdown.appendChild(option);
        }
      }
    }

    function exportToFile() {
      const blob = new Blob([fullTab], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const name = document.getElementById('tabName').value || 'tabby-tab';
      a.download = `${name}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    document.getElementById("helpBtn").onclick = function () {
      document.getElementById("helpModal").style.display = "block";
    };
    document.getElementById("aboutBtn").onclick = function () {
      document.getElementById("aboutModal").style.display = "block";
    };

    createGrid();
    loadSavedTabList();
  </script>
</body>
</html>